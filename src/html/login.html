<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
</head>
<body>

  <h1>Login</h1>

  <form id="loginForm">
    <div>
      <label for="username">Email:</label>
      <input type="text" id="email" name="email" required>
    </div>

    <div>
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required>
    </div>

    <div>
      <button type="submit">Login</button>
    </div>
  </form>

  <script>
    const form = document.getElementById('loginForm');

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // prevent normal form submit

      // Send login credentials to backend
      const res = await fetch('http://localhost:3000/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: form.email.value,
          password: form.password.value
        })
      });


	if (res.status === 403) {
		window.location.href = 'http://localhost:3000/error';
		return; // stop further execution
	  }
      // Expect JSON { context, entityEndpoint, relayState }
      const { context, entityEndpoint, relayState } = await res.json();


      // Build a form dynamically to POST the SAMLResponse to the SP ACS
      const samlForm = document.createElement('form');
      samlForm.method = 'POST';
      samlForm.action = entityEndpoint;

      const samlInput = document.createElement('input');
      samlInput.type = 'hidden';
      samlInput.name = 'SAMLResponse';
      samlInput.value = context;
      samlForm.appendChild(samlInput);

      if (relayState) {
        const relayInput = document.createElement('input');
        relayInput.type = 'hidden';
        relayInput.name = 'RelayState';
        relayInput.value = relayState;
        samlForm.appendChild(relayInput);
      }

      document.body.appendChild(samlForm);
      samlForm.submit(); 
    });
  </script>

</body>
</html>
